$.fn.alm=function(){this.almHost=$("meta[name=almHost]").attr("content");this.almAPIKey=$("meta[name=almAPIKey]").attr("content");if(!this.almHost){this.almHost="ALM_HOST_NOT_CONFIGURED"}if(!this.almAPIKey){this.almAPIKey="ALM_KEY_NOT_CONFIGURED"}this.almRequestBatchSize=parseInt($("meta[name=almRequestBatchSize]").attr("content"));if(isNaN(this.almRequestBatchSize)){this.almRequestBatchSize=30}this.isNewArticle=function(d){var c=(new Date()).getTime()-172800000;if(c<d){return true}else{return false}};this.isArticle=function(c){if(c.indexOf("image")>-1){return false}return true};this.validateDOI=function(c){if(c==null){throw new Error("DOI is null.")}c=encodeURI(c);return c.replace(new RegExp("/","g"),"%2F").replace(new RegExp(":","g"),"%3A")};this.getCitesTwitterOnly=function(d,f,c){d=this.validateDOI(d);var e=d+"&source=twitter&info=event";this.getData(e,f,c)};this.getMediaReferences=function(d,f,c){d=this.validateDOI(d);var e=d+"&source=articlecoveragecurated&info=event";this.getData(e,f,c)};this.getArticleSummaries=function(j,f,i){var d,l,m,h,k,c=new Array();if(j.length){k=j.length;m=0;h=(k<this.almRequestBatchSize)?k:this.almRequestBatchSize;while(m<k){d="";d+=this.validateDOI(j[m]);for(l=(m+1);l<h;l++){d+=","+this.validateDOI(j[l])}var g=d;var e=this.almHost+"?api_key="+this.almAPIKey+"&ids="+g;c.push($.jsonp({url:e,context:document.body,timeout:20000,callbackParameter:"callback"}));m=h;h=h+this.almRequestBatchSize;if(h>k){h=k}}}$.when.apply($,c).then(function(){var o=new Array();if(arguments.length>=2&&arguments[1]==="success"){o=o.concat(arguments[0])}else{for(var n=0;n<arguments.length;n++){o=o.concat(arguments[n][0])}}f(o)},function(){i()})};this.sortByYearMonth=function(c,d){if(parseInt(c.year)<parseInt(d.year)){return -1}else{if(parseInt(c.year)==parseInt(d.year)){if(parseInt(c.month)==parseInt(d.month)){return 0}else{if(parseInt(c.month)<parseInt(d.month)){return -1}else{return 1}}}else{return 1}}};this.massageChartData=function(d,k){var q=new Date(k);var f=q.getFullYear();var c=q.getMonth()+1;var e=null;var m=null;var j={};for(var x=0;x<d.length;x++){if(d[x].name.toLowerCase()=="counter"){e=d[x].events;e=e.sort(this.sortByYearMonth)}if(d[x].name.toLowerCase()=="pmc"){if(d[x].events&&d[x].events.length>0){m=d[x].events;m=m.sort(this.sortByYearMonth)}}if(d[x].name.toLowerCase().toLowerCase()=="relativemetric"){if(d[x].events!=null){j.relativeMetricData=d[x].events}}}j.totalPDF=0;j.totalXML=0;j.totalHTML=0;j.total=0;j.history={};for(var x=0;x<e.length;x++){if(e[x].year<f||(e[x].year==f&&e[x].month<c)){e.splice(x,1);x--}}var i=0;var s=0;var o=0;var v=0;for(var x=0;x<e.length;x++){var p=e[x];var w=this.parseIntSafe(p.html_views)+this.parseIntSafe(p.xml_views)+this.parseIntSafe(p.pdf_views);var l=this.getYearMonth(p.year,p.month);j.history[l]={};j.history[l].source={};j.history[l].year=p.year;j.history[l].month=p.month;j.history[l].source.counterViews={};j.history[l].source.counterViews.month=p.month;j.history[l].source.counterViews.year=p.year;j.history[l].source.counterViews.totalPDF=this.parseIntSafe(p.pdf_views);j.history[l].source.counterViews.totalXML=this.parseIntSafe(p.xml_views);j.history[l].source.counterViews.totalHTML=this.parseIntSafe(p.html_views);j.history[l].source.counterViews.total=w;i+=this.parseIntSafe(p.pdf_views);s+=this.parseIntSafe(p.xml_views);o+=this.parseIntSafe(p.html_views);v+=w;j.history[l].source.counterViews.cumulativePDF=i;j.history[l].source.counterViews.cumulativeXML=s;j.history[l].source.counterViews.cumulativeHTML=o;j.history[l].source.counterViews.cumulativeTotal=v;j.history[l].cumulativeTotal=this.parseIntSafe(j.total)+w;j.history[l].cumulativePDF=j.totalPDF+this.parseIntSafe(p.pdf_views);j.history[l].cumulativeXML=j.totalXML+this.parseIntSafe(p.xml_views);j.history[l].cumulativeHTML=j.totalHTML+this.parseIntSafe(p.html_views);j.history[l].total=w;j.totalPDF+=this.parseIntSafe(p.pdf_views);j.totalXML+=this.parseIntSafe(p.xml_views);j.totalHTML+=this.parseIntSafe(p.html_views);j.total+=w}j.totalCounterPDF=i;j.totalCounterXML=s;j.totalCounterHTML=o;j.totalCouterTotal=v;var r=0;var u=0;var g=0;if(m!=null){for(var x=0;x<m.length;x++){var p=m[x];var w=this.parseIntSafe(p["full-text"])+this.parseIntSafe(p.pdf);r+=this.parseIntSafe(p.pdf);u+=this.parseIntSafe(p["full-text"]);g+=w;var l=this.getYearMonth(p.year,p.month);if(j.history[l]==null){continue}j.history[l].source.pmcViews={};j.history[l].source.pmcViews.month=p.month;j.history[l].source.pmcViews.year=p.year;j.history[l].source.pmcViews.cumulativePDF=r;j.history[l].source.pmcViews.cumulativeHTML=u;j.history[l].source.pmcViews.cumulativeTotal=g;j.history[l].source.pmcViews.totalPDF=this.parseIntSafe(p.pdf);j.history[l].source.pmcViews.totalXML="n.a.";j.history[l].source.pmcViews.totalHTML=this.parseIntSafe(p["full-text"]);j.history[l].source.pmcViews.total=w;j.history[l].total+=w;j.history[l].cumulativeTotal+=w;j.history[l].cumulativePDF+=this.parseIntSafe(p.pdf);j.history[l].cumulativeHTML+=this.parseIntSafe(p["full-text"]);
j.totalPDF+=this.parseIntSafe(p.pdf);j.totalHTML+=this.parseIntSafe(p["full-text"]);j.total+=w}}j.totalPMCPDF=r;j.totalPMCHTML=u;j.totalPMCTotal=g;for(year=f;year<=(new Date().getFullYear());year++){var t=(year==f)?c:1;for(month=t;month<13;month++){if(year==(new Date().getFullYear())&&(month-1)>(new Date().getMonth())){break}l=this.getYearMonth(year,month);if(j.history[l]!=null&&j.history[l].source.pmcViews==null){j.history[l].source.pmcViews={};j.history[l].source.pmcViews.month=month+1;j.history[l].source.pmcViews.year=year;j.history[l].source.pmcViews.cumulativePDF=0;j.history[l].source.pmcViews.cumulativeHTML=0;j.history[l].source.pmcViews.cumulativeTotal=0;j.history[l].source.pmcViews.totalPDF=0;j.history[l].source.pmcViews.totalXML=0;j.history[l].source.pmcViews.totalHTML=0;j.history[l].source.pmcViews.total=0;var y=0;var h=0;if(month==1){y=12;h=year-1}else{y=month-1;h=year}var n=this.getYearMonth(h,y);if(j.history[n]!=null&&j.history[n].source.pmcViews!=null){j.history[l].source.pmcViews.cumulativePDF=j.history[n].source.pmcViews.cumulativePDF;j.history[l].source.pmcViews.cumulativeHTML=j.history[n].source.pmcViews.cumulativeHTML;j.history[l].source.pmcViews.cumulativeTotal=j.history[n].source.pmcViews.cumulativeTotal;j.history[l].source.pmcViews.totalPDF=0;j.history[l].source.pmcViews.totalHTML=0;j.history[l].source.pmcViews.total=0}else{j.history[l].source.pmcViews.cumulativePDF=0;j.history[l].source.pmcViews.cumulativeHTML=0;j.history[l].source.pmcViews.cumulativeTotal=0;j.history[l].source.pmcViews.totalPDF=0;j.history[l].source.pmcViews.totalHTML=0;j.history[l].source.pmcViews.total=0}}}}if(j.totalPMCTotal==0){j.totalPMCPDF=0;j.totalPMCHTML=0;j.totalPMCTotal=0}return j};this.parseIntSafe=function(c){if(isNaN(c)){return 0}return parseInt(c)};this.getYearMonth=function(c,d){if(this.parseIntSafe(d)<10){return c+"-0"+d}else{return c+"-"+d}};this.setCrossRefText=function(c,h,f,d){var e=function(i){var j=$("#"+f);j.html("Citations are currently not available, please check back later.");j.show("blind",500);$("#"+d).fadeOut("slow")};var g=function(i){this.setCrossRefLinks(i,h);$("#"+d).fadeOut("slow")};this.getCitesCrossRefOnly(c,jQuery.proxy(g,this),e)};this.getCitesCrossRefOnly=function(d,f,c){d=this.validateDOI(d);var e=d+"&source=crossref&info=event";this.getData(e,f,c)};this.setCrossRefLinks=function(e,d){var n=encodeURIComponent(e[0].doi);var l=this.filterSources(e[0].sources,["crossref"])[0];var p=0;if(l.metrics.total>0){p=l.metrics.total;var j="";for(var c=0;c<l.events.length;c++){var m=l.events[c].event;var o=l.events[c].event_url;j=j+"<li><span class='article'><a href=\""+o+'">'+m.article_title+'</a> <span class="pubGetPDFLink" id="citation_'+this.fixDoiForID(m.doi)+'"></span></span>';if(m.contributors){var g="";var q="";var f="";var k=m.contributors.contributor;for(var h=0;h<k.length;h++){individualContributor=k[h];if(individualContributor.first_author==="true"){if(individualContributor.surname){g=individualContributor.surname;if(individualContributor.given_name&&individualContributor.given_name.length>0){g=g+" "+individualContributor.given_name.substr(0,1)}}}else{f="";if(individualContributor.surname){f=individualContributor.surname;if(individualContributor.given_name&&individualContributor.given_name.length>0){f=f+" "+individualContributor.given_name.substr(0,1)}q=q+", "+f}}}q=g+q;j=j+"<span class='authors'>"+q+"</span>"}j=j+"<span class='articleinfo'>";if(m.journal_title!=null){j=j+m.journal_title}if(m.year!=null){j=j+" "+m.year}if(m.volume!=null){j=j+" "+m.volume}if(m.issue!=null){j=j+"("+m.issue+")"}if(m.first_page){j=j+": "+m.first_page}j=j+". doi:"+m.doi+"</span></li>"}}if(p<1){j="<h3>No related citations found</h3>"}else{var r="";if(p!=1){r="s"}j=p+" citation"+r+' as recorded by <a href="http://www.crossref.org">CrossRef</a>.  Article published '+$.datepicker.formatDate("M dd, yy",new Date(e[0].publication_date))+". Citations updated on "+$.datepicker.formatDate("M dd, yy",new Date(e[0].update_date))+". <ol>"+j+"</ol>"}$("#"+d).html(j);$("#"+d).show("blind",500)};this.fixDoiForID=function(c){return c.replace(/\//g,":")};this.getData=function(e,f,c){var d=this.almHost+"?api_key="+this.almAPIKey+"&ids="+e;$.jsonp({url:d,context:document.body,timeout:20000,callbackParameter:"callback",success:f,error:function(h,g){c("Our system is having a bad day. We are working on it. Please check back later.")}});console.log(d)};this.setSavedSuccess=function(k,e,h,i,j){var p=$("#"+e);$("#"+h).fadeOut("slow");p.css("display","none");var g=["citeulike","connotea","mendeley"];var d=this.filterSources(k[0].sources,g);var l={},q="";var n=true;for(var m=0;m<d.length;m++){var c=d[m];if(c.metrics.total>0){n=false;c.display_name=c.display_name.replace(/\s/g,"");if(c.name=="mendeley"){l[c.name]=this.createMetricsTile(c.display_name,c.events_url,"/images/logo-"+c.name+".png",c.metrics.total);var o=c.metrics.shares;var f=c.metrics.groups;q='<div class="tileTooltip"><table class="tile_mini"><thead><tr><th>Individuals</th><th>Groups</th></tr></thead><tbody><tr><td class="data1">'+o.format(0,".",",")+'</td><td class="data2">'+f.format(0,".",",")+"</td></tr></tbody></table></div>"
}else{if(!c.events_url){l[c.name]=this.createMetricsTileNoLink(c.display_name,"/images/logo-"+c.name+".png",c.metrics.total)}else{l[c.name]=this.createMetricsTile(c.display_name,c.events_url,"/images/logo-"+c.name+".png",c.metrics.total)}}}}for(var m=0;m<g.length;m++){if(g[m] in l){p.append(l[g[m]])}}$("#MendeleyImageOnArticleMetricsTab").tooltip({backgroundColor:"rgba(255, 255, 255, 0.0)",delay:250,fade:250,track:true,shadow:false,showURL:false,bodyHandler:function(){return $(q)}});if(n){$("#socialNetworksOnArticleMetricsPage").css("display","none")}else{i("#"+e);p.show("blind",500,j)}};this.setSavedError=function(e,f,d,c,g){$("#"+d).fadeOut("slow");$("#"+f).html('<img src="/images/icon_error.png"/>&nbsp;'+e);c();$("#"+f).show("blind",500,g)};this.createMetricsTile=function(d,c,f,e){return'<div id="'+d+'OnArticleMetricsTab" class="metrics_tile"><a href="'+c+'"><img id="'+d+'ImageOnArticleMetricsTab" src="'+f+'" alt="'+e+" "+d+'" class="metrics_tile_image"/></a><div class="metrics_tile_footer" onclick="location.href=\''+c+'\';"><a href="'+c+'">'+e+"</a></div></div>"};this.createMetricsTileNoLink=function(c,e,d){return'<div id="'+c+'OnArticleMetricsTab" class="metrics_tile_no_link"><img id="'+c+'ImageOnArticleMetricsTab" src="'+e+'" alt="'+d+" "+c+'" class="metrics_tile_image"/><div class="metrics_tile_footer_no_link">'+d+"</div></div>"};this.setDiscussedSuccess=function(c,r,t,f,o){$("#"+t).fadeOut("slow");var h=$("#"+r);h.css("display","none");var e=$("meta[name=citation_title]").attr("content");var s=encodeURI($("meta[name=citation_doi]").attr("content"));var p=null,g="";var n=["researchblogging","scienceseeker","nature","wordpress","wikipedia","twitter","facebook","reddit"];var d=this.filterSources(c[0].sources,n);var m={};for(var i=0;i<d.length;i++){p=d[i];if(p.metrics.total>0){p.display_name=p.display_name.replace(/\s/g,"");if(p.name==="facebook"){m[p.name]=this.createMetricsTileNoLink(p.display_name,"/images/logo-"+p.name+".png",p.metrics.total);var k=p.metrics.likes;var q=p.metrics.shares;var j=p.metrics.comments;g='<div class="tileTooltip"><table class="tile_mini"><thead><tr><th>Likes</th><th>Shares</th><th>Posts</th></tr></thead><tbody><tr><td class="data1">'+k.format(0,".",",")+'</td><td class="data2">'+q.format(0,".",",")+'</td><td class="data1">'+j.format(0,".",",")+"</td></tr></tbody></table></div>"}else{if(p.name==="twitter"){m[p.name]=this.createMetricsTile(p.display_name,"/article/twitter/info:doi/"+s,"/images/logo-"+p.name+".png",p.metrics.total)}else{if(!p.events_url){m[p.name]=this.createMetricsTileNoLink(p.display_name,"/images/logo-"+p.name+".png",p.metrics.total)}else{p.events_url=p.events_url.replace(/"/g,"%22");m[p.name]=this.createMetricsTile(p.display_name,p.events_url,"/images/logo-"+p.name+".png",p.metrics.total)}}}}}for(var i=0;i<n.length;i++){if(n[i] in m){h.append(m[n[i]])}}$("#notesAndCommentsOnArticleMetricsTab").appendTo(h);$("#trackbackOnArticleMetricsTab").appendTo(h);var l=this.createMetricsTile("google-blogs","http://blogsearch.google.com/blogsearch?as_q=%22"+e+"%22","/images/logo-googleblogs.png","Search");h.append(l);$("#FacebookOnArticleMetricsTab").tooltip({delay:250,fade:250,track:true,showURL:false,bodyHandler:function(){return $(g)}});f("#"+r);h.show("blind",500,o)};this.setDiscussedError=function(i,d,e,c,j){var g=$("#"+d);g.css("display","none");var h=$("meta[name=citation_title]").attr("content");var f="Search for related blog posts on <a href='http://blogsearch.google.com/blogsearch?as_q=%22"+h+"%22'>Google Blogs</a><br/><img src='/images/icon_error.png'/>&nbsp;"+i;g.html(f);$("#"+e).fadeOut("slow");c();g.show("blind",500,j)};this.setCitesSuccess=function(k,f,h,i,j){$("#"+h).fadeOut("slow");$("#"+f).css("display","none");var o=0;var p=encodeURI($("meta[name=citation_doi]").attr("content"));var l="";var d=this.filterSources(k[0].sources,["crossref","pubmed","scopus","wos","pmceurope","pmceuropedata","datacite"]);var g=["scopus","crossref","pubmed","wos","pmceurope","pmceuropedata","datacite","google"];var m={};for(var n=0;n<d.length;n++){var c=d[n];if(c.metrics.total>0){o++;var e=c.events_url;c.display_name=c.display_name.replace(/\s/g,"");c.display_name=c.display_name.replace("\u00ae","");if(c.name.toLowerCase()=="crossref"){m[c.name]=this.createMetricsTile(c.display_name,"/article/crossref/info:doi/"+p,"/images/logo-"+c.name+".png",c.metrics.total)}else{if(c.events_url){m[c.name]=this.createMetricsTile(c.display_name,e,"/images/logo-"+c.name+".png",c.metrics.total)}else{m[c.name]=this.createMetricsTileNoLink(c.display_name,"/images/logo-"+c.name+".png",c.metrics.total)}}}}var q="http://dx.plos.org/"+p.replace("info%3Adoi/","");if(o!=0){m.google=this.createMetricsTile("GoogleScholar","http://scholar.google.com/scholar?hl=en&lr=&cites="+q,"/images/logo-google-scholar.png","Search");for(var n=0;n<g.length;n++){if(g[n] in m){l=l+m[g[n]]}}}else{l='No related citations found<br/>Search for citations in <a href="http://scholar.google.com/scholar?hl=en&lr=&cites='+q+'">Google Scholar</a>'
}$("#"+f).html(l);i("#"+f);$("#"+f).show("blind",500,j)};this.setCitesError=function(f,c,e,d,g){$("#"+e).fadeOut("slow");$("#"+c).html('<img src="/images/icon_error.png"/>&nbsp;'+f);d();$("#"+c).show("blind",500,g)};this.setF1000Success=function(h,g,f,j,e,i){var c=this.filterSources(h[0].sources,["f1000"]).pop();if(!c){return}if(c.metrics.total==0){return}var d=encodeURI($("meta[name=citation_doi]").attr("content"));$("#"+g).show("blind",500);e("#"+j);$("#"+f).fadeOut("slow");$("#"+j).append(this.createMetricsTile(c.display_name,c.events_url,"/images/logo-"+c.name+".png",c.metrics.total)).show("blind",500,i)};this.setChartData=function(i,k,d,e,f,c){var h=$.datepicker.parseDate("yy/m/d",$("meta[name=citation_date]").attr("content"));publishDatems=h.getTime();if(this.isNewArticle(publishDatems)){$("#"+k).html("This article was only recently published. Although we update our data on a daily basis (not in real time), there may be a 48-hour delay before the most recent numbers are available.<br/><br/>");e();$("#"+k).show("blind",500,f);$("#"+d).fadeOut("slow");c()}else{if(this.isArticle(i)){var l=function(m){e();$("#"+d).fadeOut("slow");$("#"+k).html('<img src="/images/icon_error.png"/>&nbsp;'+m);$("#"+k).show("blind",500,f);c()};var j=function(n){var r=$("#"+k);$("#"+d).fadeOut("slow");r.css("display","none");var p=this.massageChartData(n[0].sources,publishDatems);var o=$('<div id="pageViewsSummary"><div id="left"><div class="header">Total Article Views</div><div class="totalCount">'+p.total.format(0,".",",")+'</div><div class="pubDates">'+$.datepicker.formatDate("M d, yy",h)+" (publication date)<br>through "+$.datepicker.formatDate("M d, yy",new Date())+'*</div></div><div id="right"><table id="pageViewsTable"><tbody><tr><th></th><th nowrap="">HTML Page Views</th><th nowrap="">PDF Downloads</th><th nowrap="">XML Downloads</th><th>Totals</th></tr><tr><td class="source1">PLOS</td><td>'+p.totalCounterHTML.format(0,".",",")+"</td><td>"+p.totalCounterPDF.format(0,".",",")+"</td><td>"+p.totalCounterXML.format(0,".",",")+'</td><td class="total">'+p.totalCouterTotal.format(0,".",",")+'</td></tr><tr><td class="source2">PMC</td><td>'+p.totalPMCHTML.format(0,".",",")+"</td><td>"+p.totalPMCPDF.format(0,".",",")+'</td><td>n.a.</td><td class="total">'+p.totalPMCTotal.format(0,".",",")+'</td></tr><tr><td>Totals</td><td class="total">'+p.totalHTML.format(0,".",",")+'</td><td class="total">'+p.totalPDF.format(0,".",",")+'</td><td class="total">'+p.totalXML.format(0,".",",")+'</td><td class="total">'+p.total.format(0,".",",")+'</td></tr><tr class="percent"><td colspan="5"><b>'+((p.totalPDF/p.totalHTML)*100).format(2,".",",")+"%</b> of article views led to PDF downloads</td></tr></tbody></table></div></div>");var m=$.map(p.history,function(w,v){return v});r.append(o);var s=Object.keys(p.history).length>1;if(s){var u=this.buildChartOptions(p,m);for(var t in p.history){if(p.history[t].source.pmcViews!=null){u.series[0].data.push({name:t,y:p.history[t].source.pmcViews.cumulativeTotal})}else{u.series[0].data.push({name:t,y:0})}u.series[1].data.push({name:t,y:p.history[t].source.counterViews.cumulativeTotal})}r.append($('<div id="chart"></div>').css("width","600px").css("height","200px"));e();var q=new Highcharts.Chart(u);this.addRelativeMetricInfo(p,m,q,r,e)}r.append($("<p>*Although we update our data on a daily basis, there may be a 48-hour delay before the most recent numbers are available. PMC data is posted on a monthly basis and will be made available once received.</p>"));this.addFigshareTile(n[0]);e();r.show("blind",500,function(){f();c()})};i=this.validateDOI(i);var g=i+"&source=pmc,counter,relativemetric,figshare&info=event";this.getData(g,jQuery.proxy(j,this),l)}}};this.buildChartOptions=function(e,d){var c={chart:{renderTo:"chart",animation:false,margin:[40,40,40,80]},credits:{enabled:false},exporting:{enabled:false},title:{text:null},legend:{enabled:false},xAxis:{title:{text:"Months",style:{fontFamily:"'FS Albert Web Regular', Verdana, sans-serif",fontWeight:"normal",color:"#000"},align:"high"},labels:{step:(d.length<15)?1:Math.round(d.length/15),formatter:function(){return this.value+1}},categories:[]},yAxis:[{title:{text:"Cumulative Views",style:{fontFamily:"'FS Albert Web Regular', Verdana, sans-serif",fontWeight:"normal",color:"#000",height:"50px"}},labels:{style:{color:"#000"}}}],plotOptions:{column:{stacking:"normal"},animation:false,series:{pointPadding:0,groupPadding:0,borderWidth:0,shadow:false}},series:[{name:"PMC",type:"column",data:[],color:"#6d84bf"},{name:"PLOS",type:"column",data:[],color:"#3c63af"}],tooltip:{backgroundColor:"rgba(255, 255, 255, 0.0)",useHTML:true,shared:true,shadow:false,borderWidth:0,borderRadius:0,positioner:function(j,g,f){var i=f.plotX+(g/2)+25,h=f.plotY-(j/2)+25;return{x:i,y:h}},formatter:function(){var f=this.points[0].key,g=e.history;return'<table id="mini" cellpadding="0" cellspacing="0"><tr><th></td><td colspan="2">Views in '+$.datepicker.formatDate("M yy",new Date(g[f].year,g[f].month-1,2))+'</td><td colspan="2">Views through '+$.datepicker.formatDate("M yy",new Date(g[f].year,g[f].month-1,2))+'</td></tr><tr><th>Source</th><th class="header1">PLOS</th><th class="header2">PMC</th><th class="header1">PLOS</th><th class="header2">PMC</th></tr><tr><td>HTML</td><td class="data1">'+g[f].source.counterViews.totalHTML+'</td><td class="data2">'+(g[f].source.hasOwnProperty("pmcViews")?g[f].source.pmcViews.totalHTML.format(0,".",","):"n.a.")+'</td><td class="data1">'+g[f].source.counterViews.cumulativeHTML.format(0,".",",")+'</td><td class="data2">'+(g[f].source.hasOwnProperty("pmcViews")?g[f].source.pmcViews.cumulativeHTML.format(0,".",","):"n.a.")+'</td></tr><tr><td>PDF</td><td class="data1">'+g[f].source.counterViews.totalPDF+'</td><td class="data2">'+(g[f].source.hasOwnProperty("pmcViews")?g[f].source.pmcViews.totalPDF.format(0,".",","):"n.a.")+'</td><td class="data1">'+g[f].source.counterViews.cumulativePDF.format(0,".",",")+'</td><td class="data2">'+(g[f].source.hasOwnProperty("pmcViews")?g[f].source.pmcViews.cumulativePDF.format(0,".",","):"n.a.")+'</td></tr><tr><td>XML</td><td class="data1">'+g[f].source.counterViews.totalXML+'</td><td class="data2">n.a.</td><td class="data1">'+g[f].source.counterViews.cumulativeXML.format(0,".",",")+'</td><td class="data2">n.a.</td></tr><tr><td>Total</td><td class="data1">'+g[f].source.counterViews.total+'</td><td class="data2">'+(g[f].source.hasOwnProperty("pmcViews")?g[f].source.pmcViews.total.format(0,".",","):"n.a.")+'</td><td class="data1">'+g[f].source.counterViews.cumulativeTotal.format(0,".",",")+'</td><td class="data2">'+(g[f].source.hasOwnProperty("pmcViews")?g[f].source.pmcViews.cumulativeTotal.format(0,".",","):"n.a.")+"</td></tr></table>"
}}};return c};this.addRelativeMetricInfo=function(u,t,j,s,e){if(u.relativeMetricData!=null){var h=u.relativeMetricData.subject_areas;if(h&&h.length>0){var l=new Array();for(var n=0;n<h.length;n++){var f=h[n].subject_area;var p=h[n].average_usage;if(p.length>=2){l.push(f);if(p.length>t.length){p=p.slice(0,t.length)}e();j.addSeries({id:f,data:p,type:"line",color:"#01DF01",marker:{enabled:false,states:{hover:{enabled:false}}}});e();j.get(f).hide()}}if(l.length>0){var q;var r=$('<select id="subject_areas"></select>');l.sort();for(n=0;n<l.length;n++){var m=l[n].substr(1);var o=m.split("/");if(o.length==1){r.append($("<option></option>").attr("value",l[n]).text(o[0]))}else{if(o.length==2){r.append($("<option></option>").attr("value",l[n]).html("&nbsp;&nbsp;&nbsp;"+o[1]));if(q==null){q=l[n]}}}}if(q==null){q=l[0]}r.find('option[value="'+q+'"]').attr("selected","selected");j.get(q).show();r.change(function(){$("#subject_areas option").each(function(){j.get($(this).val()).hide()});j.get($(this).val()).show();var i=$('input[name="refsetLinkValue"]').val();$("#linkToRefset").attr("href",i.replace("SUBJECT_AREA",$(this).val()))});var c=$("<div></div>").html('<span class="colorbox"></span>&nbsp;Compare average usage for articles published in <b>'+new Date(u.relativeMetricData.start_date).getUTCFullYear()+'</b> in the subject area: <a href="/static/almInfo#relativeMetrics" class="ir" title="More information">info</a>');var g="/search/advanced?pageSize=12&unformattedQuery=(publication_date:["+u.relativeMetricData.start_date+" TO "+u.relativeMetricData.end_date+']) AND subject:"SUBJECT_AREA"';var k=$("<div></div>").append(r).append('&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;<a id="linkToRefset" href="'+encodeURI(g.replace("SUBJECT_AREA",q))+'" >Show reference set</a>').append('<input type="hidden" name="refsetLinkValue" value="'+encodeURI(g)+'" >');var d=$('<div id="averageViewsSummary"></div>').append(c).append(k);s.append(d)}}}};this.addFigshareTile=function(c){var d=0,g;for(d=0;d<c.sources.length;d++){g=c.sources[d];if(g.name.toLowerCase()=="figshare"){if(g.metrics.total>0){var f=g.name;var e=this.createMetricsTileNoLink(f,"/images/logo-"+f+".png",g.metrics.total);$("#views").append(e)}else{return}break}}$.ajax({url:"/article/figureTableList.action?uri=info:doi/"+c.doi,dataFilter:function(i,h){return i.replace(/(^\/\*|\*\/$)/g,"")},dataType:"json",error:function(h,j,i){console.log(i)},success:function(l){var h=$('<div id="popup"></div>'),j=$('<table class="tile_mini"></table>'),q,k,o,p={};for(d=0;d<g.events.length;d++){q=g.events[d],k=0,o="";if(typeof q.doi!=="undefined"&&q.doi.length>0){var m=/\.s\d+$/g;if(q.doi.length==1&&!m.test(q.doi[0])){o=q.doi[0].replace("http://dx.doi.org/","")}else{o="SI"}}var i=new Object();k=q.stats.downloads+q.stats.page_views;i.stat='<td class="data1">'+k+"</td>";i.link=q.figshare_url;p[o]=i}for(d=0;d<l.secondaryObjects.length;d++){o=l.secondaryObjects[d].doi.replace("info:doi/","");var n='<a href="'+p[o].link+'" target=_blank>'+l.secondaryObjects[d].title+"</a>";j.append("<tr><td>"+n+"</td>"+p[o].stat+"</tr>")}if(p.SI){var n='<a href="'+p.SI.link+'" target=_blank>  Supporting Info Files </a>';j.append("<tr><td>"+n+"</td>"+p.SI.stat+"</tr>")}h.append(j);h.dialog({dialogClass:"tooltip-like figure-table",autoOpen:false,draggable:false,resizable:false,height:"auto",width:"auto",closeText:"",modal:true,position:{my:"left top",at:"right center",of:"#figshareImageOnArticleMetricsTab"},open:function(){$(".ui-widget-overlay").bind("click",function(){h.dialog("close")})}});$("#figshareImageOnArticleMetricsTab").click(function(){h.dialog("open")})}})};this.makeSignPostLI=function(h,g,f,e){var d='<a href="'+e+'">'+h+"</a>";var c=$('<li><div class="top">'+g.format(0,".",",")+'</div><div class="bottom"><div class="center"><div class="text">'+d+'<div class="content"><div class="description"><a href="'+e+'">'+f+"</a>.</div></div></div></div></div></li>");(function(){this.hoverEnhanced({})}).apply(c);return c};this.setMetricsTab=function(e,d,g,f){e=this.validateDOI(e);var h=function(i){this.setCitesSuccess(i,"relatedCites","relatedCitesSpinner",d,g);this.setSavedSuccess(i,"relatedBookmarks","relatedBookmarksSpinner",d,g);this.setDiscussedSuccess(i,"relatedBlogPosts","relatedBlogPostsSpinner",d,g);this.setF1000Success(i,"f1kHeader","f1KSpinner","f1kContent",d,g);f()};var c=function(i){this.setCitesError(i,"relatedCites","relatedCitesSpinner",d,g);this.setSavedError(i,"relatedBookmarks","relatedBookmarksSpinner",d,g);this.setDiscussedError(i,"relatedBlogPosts","relatedBlogPostsSpinner",d,g);f()};this.getData(e,$.proxy(h,this),$.proxy(c,this))};this.filterSources=function(d,c){validSources=[];for(var e=0;e<d.length;e++){if($.inArray(d[e].name.toLowerCase(),c)>-1){validSources.push(d[e])}}return validSources};this.enforceOrder=function(f,c){var g=[];for(var j=0;j<f.length;j++){g.push(f[j].name)}var h=[];for(var i=0;i<c.length;i++){var e=$.inArray(c[i],g);if(e>-1){h.push(f[e])}}return h}};function onReadyALM(){var f=300,h=172800000;
if($("#almSignPost").length>0){var i=new $.fn.alm(),d=$("meta[name=citation_doi]").attr("content"),c=$.datepicker.parseDate("yy/m/d",$("meta[name=citation_date]").attr("content")),j=c.getTime();var g=function(k){$("#almSignPostSpinner").css("display","none");if(j>((new Date().getTime())-h)){}else{$("#almSignPost").append($("<li></li>").text("metrics unavailable").css("vertical-align","middle"));$("#almSignPost").fadeIn(f)}};var e=function(k){var t,m,z,C;if(k&&k.length>0){t=k[0];var s,D,n,o,r,q,x,p,B,l;m=t.sources;for(var A=0;A<m.length;A+=1){z=m[A];if(z.name.toLowerCase()=="counter"){s=z}else{if(z.name.toLowerCase()=="pmc"){D=z}else{if(z.name.toLowerCase()=="scopus"){n=z}else{if(z.name.toLowerCase()=="facebook"){o=z}else{if(z.name.toLowerCase()=="twitter"){r=z}else{if(z.name.toLowerCase()=="mendeley"){q=z}else{if(z.name.toLowerCase()=="citeulike"){x=z}else{if(z.name.toLowerCase()=="crossref"){p=z}else{if(z.name.toLowerCase()=="articlecoveragecurated"){B=z}}}}}}}}}}l="/article/metrics/info:doi/"+$("meta[name=citation_doi]").attr("content");C=s.metrics.total+D.metrics.total;if(C>0){v=i.makeSignPostLI("VIEWS",s.metrics.total+D.metrics.total,"Sum of PLOS and PubMed Central page views and downloads",l+"#viewedHeader");$("#almSignPost").append(v)}var w,v;if(n.metrics.total>0){w="CITATIONS";if(n.metrics.total==1){w="CITATION"}v=i.makeSignPostLI(w,n.metrics.total,"Paper's citation count computed by Scopus",l+"#citedHeader");$("#almSignPost").append(v)}else{if(p.metrics.total>0){w="CITATIONS";if(p.metrics.total==1){w="CITATION"}v=i.makeSignPostLI(w,p.metrics.total,"Scopus data unavailable. Displaying Crossref citation count",l+"#citedHeader");$("#almSignPost").append(v)}}var y=q.metrics.total+x.metrics.total;if(y>0){w="SAVES";if(y==1){w="SAVE"}v=i.makeSignPostLI(w,q.metrics.total+x.metrics.total,"Total Mendeley and CiteULike bookmarks",l+"#savedHeader");$("#almSignPost").append(v)}var u=o.metrics.total+r.metrics.total;if(u>0){w="SHARES";if(u==1){w="SHARE"}v=i.makeSignPostLI(w,o.metrics.total+r.metrics.total,"Sum of Facebook and Twitter activity",l+"#discussedHeader");$("#almSignPost").append(v)}$("#almSignPost").fadeIn(f);if(B.metrics.total>0){buildMediaCoverageLink(B.metrics.total)}}};i.getArticleSummaries([d],e,g)}}function jumpToALMSection(){var c=$(location).attr("href");var d=c.indexOf("#");if(d==-1){return}var e=c.slice(d);verticalPosition=$(e).position().top;scrollTo(0,verticalPosition)}$(document).ready(onReadyALM);function onLoadALM(){var e=new $.fn.alm();var g=$("meta[name=citation_doi]").attr("content");var c=0;var j=0;var k=false;var f=false;var m=function(){return k&&f&&c==j};var l=function(){c++};var d=function(){j++;if(m()){jumpToALMSection()}};var i=function(){k=true;if(m()){jumpToALMSection()}};var h=function(){f=true;if(m()){jumpToALMSection()}};e.setMetricsTab(g,l,d,i);e.setChartData(g,"usage","chartSpinner",l,d,h)}function setALMSearchWidgets(k){for(a=0;a<k.length;a++){var m=k[a];var l=m.doi;var c=m.sources;var j,p,d,q,g,i,e,o,h,f;j=p=d=q=g=i=e=o=h=f=null;var n=[];for(var t=0;t<c.length;t++){n.push(c[t].name)}j=c[n.indexOf("scopus")];p=c[n.indexOf("citeulike")];o=c[n.indexOf("pubmed")];d=c[n.indexOf("counter")];q=c[n.indexOf("mendeley")];g=c[n.indexOf("crossref")];i=c[n.indexOf("wos")];e=c[n.indexOf("pmc")];h=c[n.indexOf("facebook")];f=c[n.indexOf("twitter")];var r=false;if(j.metrics.total>0||p.metrics.total>0||e.metrics.total+d.metrics.total>0||q.metrics.total>0||h.metrics.shares+f.metrics.total>0){r=true}if(r){confirmed_ids[confirmed_ids.length]=l;makeALMSearchWidget(l,j,p,d,q,g,i,e,o,h,f)}}confirmALMDataDisplayed()}function makeALMSearchWidget(l,k,o,c,p,f,h,d,n,g,e){var i=getSearchWidgetByDOI(l);var m=getMetricsURL(l);var j=$(i).fadeOut(250,function(){var q=$("<span></span>");q.addClass("almSearchWidget");buildWidgetText(q,m,k,o,c,p,f,h,d,n,g,e);$(i).html("");$(i).append(q);$(i).fadeIn(250)})}function buildWidgetText(r,q,d,o,m,j,f,h,t,c,e,l){var g=null;var u=t.metrics.total+m.metrics.total;var n=t.metrics.html+m.metrics.html;var s=t.metrics.pdf+m.metrics.pdf;var k=u-s-t.metrics.html-m.metrics.html;if(u>0){g=$("<a></a>").attr("href",q+"#usage").html("Views: "+u.format(0,".",",")).addClass("data");g.tooltip({delay:250,fade:250,top:-40,left:20,track:true,showURL:false,bodyHandler:function(){return'<span class="searchResultsTip">HTML: <b>'+n.format(0,".",",")+"</b>, PDF: <b>"+s.format(0,".",",")+"</b>, XML: <b>"+k.format(0,".",",")+"</b>, Grand Total: <b>"+u.format(0,".",",")+"</b></span>"}});r.append($("<span></span>").append(g))}else{r.appendChild($("<span></span>").addClass("no-data").html("Views: Not available"))}if(d.metrics.total>0){g=$("<a></a>").attr("href",q+"#citations").html("Citations: "+d.metrics.total.format(0,".",",")).addClass("data");g.tooltip({delay:250,fade:250,top:-40,left:20,track:true,showURL:false,bodyHandler:function(){var y=[f,c,h];var v=d.display_name+": <b>"+d.metrics.total.format(0,".",",")+"</b>";for(var w=0;w<y.length;w++){var x=y[w];if(x.metrics.total>0){v+=", "+x.display_name+": <b>"+x.metrics.total.format(0,".",",")+"</b>"
}}return'<span class="searchResultsTip">'+v+"</span>"}});appendBullIfNeeded(r);r.append($("<span></span>").append(g))}else{appendBullIfNeeded(r);r.append($("<span></span>").html("Citations: None").addClass("no-data"))}var i=j.metrics.total+o.metrics.total;if(i>0){g=$("<a></a>").attr("href",q+"#other").html("Saves: "+i.format(0,".",",")).addClass("data");appendBullIfNeeded(r);g.tooltip({delay:250,fade:250,top:-40,left:20,track:true,showURL:false,bodyHandler:function(){var v="";if(j.metrics.total>0){v+=j.display_name+": <b>"+j.metrics.total.format(0,".",",")+"</b>"}if(o.metrics.total>0){if(v!=""){v+=", "}v+=o.display_name+": <b>"+o.metrics.total.format(0,".",",")+"</b>"}return'<span class="searchResultsTip">'+v+"</span>"}});r.append($("<span></span>").append(g))}else{appendBullIfNeeded(r);r.append($("<span></span>").html("Saves: None").addClass("no-data"))}var p=e.metrics.shares+l.metrics.total;if(p>0){g=$("<a></a>").attr("href",q+"#other").html("Shares: "+p).addClass("data");appendBullIfNeeded(r);g.tooltip({delay:250,fade:250,top:-40,left:20,track:true,showURL:false,bodyHandler:function(){var v="";if(e.metrics.shares>0){v+=e.display_name+": <b>"+e.metrics.shares.format(0,".",",")+"</b>"}if(l.metrics.total>0){if(v!=""){v+=", "}v+=l.display_name+": <b>"+l.metrics.total.format(0,".",",")+"</b>"}return'<span class="searchResultsTip">'+v+"</span>"}});r.append($("<span></span>").append(g))}else{appendBullIfNeeded(r);r.append($("<span></span>").html("Shares: None").addClass("no-data"))}}function appendBullIfNeeded(c){if(c.size()>0){c.append("&nbsp;&bull;&nbsp;")}}function getSearchWidgetByDOI(c){return $("li[data-doi='"+c+"'] span.metrics")}function getMetricsURL(c){return $($("li[data-doi='"+c+"']")[0]).data("metricsurl")}function setALMSearchWidgetsError(){confirmALMDataDisplayed()}function makeALMSearchWidgetError(c,g){var d=getSearchWidgetByDOI(c);var e=d[0];var f=$("<span></span>");f.addClass("inlineError");f.css("display","none");f.html(g);$(e).find("span").fadeOut(250,function(){$(e).append(f);$(f).fadeIn(250)})}function confirmALMDataDisplayed(){if(confirmed_ids!=null){for(a=0;a<confirmed_ids.length;a++){for(b=0;b<ids.length;b++){if(confirmed_ids[a]==ids[b]){ids.remove(b)}}}}for(a=0;a<ids.length;a++){var c=$("li[data-doi='"+ids[a]+"']");var d=$(c[0]).data("pdate");if(d>((new Date().getTime())-172800000)){makeALMSearchWidgetError(ids[a],"Metrics unavailable for recently published articles. Please check back later.")}else{makeALMSearchWidgetError(ids[a],'<img src="../images/icon_error.png"/>&nbsp;Metrics unavailable. Please check back later.')}}}function buildMediaCoverageLink(c){var d=$("<a></a>").attr("href","/article/related/info:doi/"+$("meta[name=citation_doi]").attr("content")).text("Media Coverage ("+c+")");if($("#nav-article-page #nav-figures").length>0){$("#nav-article-page #nav-figures").before($("<li></li>").append(d))}else{$("#nav-article-page ul:nth-child(2)").append($("<li></li>").append(d))}}function addMediaCoverageLink(){var f=new $.fn.alm(),c=$("meta[name=citation_doi]").attr("content");var d=function(g){var l,h,k;if(g&&g.length>0){l=g[0];h=l.sources;for(var j=0;j<h.length;j++){k=h[j];if(k.name.toLowerCase()=="articlecoveragecurated"){if(k.metrics.total>0){buildMediaCoverageLink(k.metrics.total)}break}}}};var e=function(){};f.getArticleSummaries([c],d,e)};